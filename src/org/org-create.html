<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../common/api-ajax.html">
<link rel="import" href="../common/paper-loading-fab.html">
<link rel="import" href="../org/org-wizard-shared-styles.html">

<dom-module id="org-create">
  <template>
    <style include="org-wizard-shared-styles"></style>

    <api-ajax id="post" method="post" url="/orgs" body="[[body]]" loading="{{loading}}"></api-ajax>
    <firebase-document path="/org-infos/[[body.name]]" data="{{existingOrg}}"></firebase-document>

    <h2>Create new organization</h2>
    <paper-input
      label="Name"
      type="text"
      value="{{body.name}}"
      required
      auto-validate
      error-message="Provide a name">
    </paper-input>
    <span class="error-message" hidden="[[!existingOrg.name]]">[[body.name]] already exisits.</span>
    <paper-loading-fab
      class="advance-button"
      icon="arrow-forward"
      on-tap="submit"
      loading="[[loading]]"
      disabled="[[!valid]]">
    </paper-loading-fab>

  </template>
  <script>
    class OrgCreate extends Polymer.Element {
      static get is () { return 'org-create' }
      static get properties () {
        return {
          body: {
            type: Boolean,
            value: {}
          },
          valid: {
            type: Boolean,
            computed: '_computeValid(body.name, existingOrg.name)'
          },
          createdOrg: {
            type: Object,
            notify: true
          }
        }
      }
      static get observers () {
        return ['_fixName(body.name)']
      }
      submit () {
        this.$.post.generateRequest().completes
          .then((req) => {
            this.set('createdOrg', req.response)
            this.dispatchEvent(new CustomEvent('advanced'))
          })
      }
      _fixName (name) {
        if (!name || name === name.toLowerCase()) return
        this.set('body.name', name.toLowerCase())
      }
      _computeValid (name, existingName) {
        return !!name && !existingName
      }
    }

    window.customElements.define(OrgCreate.is, OrgCreate)
  </script>
</dom-module>
